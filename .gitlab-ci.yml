stages:
    - builds
    - fmt
    - tests
    
before_script:
    - export PATH="$HOME/.cargo/bin:$PATH"
    
build-rust-stable:
  stage: builds
  tags:
    - redshift-rs-stable
  script:
    - cargo build
    
build-rust-beta:
  stage: builds
  tags:
    - redshift-rs-beta
  script:
    - rustup update
    - cargo build
  allow_failure: true
    
build-rust-nightly:
  stage: builds
  tags:
    - redshift-rs-nightly
  script:
    - rustup update
    - cargo build
  allow_failure: true
    
fmt:
  stage: fmt
  tags:
    - redshift-rs-nightly
  before_script:
    - export PATH="$HOME/.cargo/bin:$PATH"
    - rustup update
    - cargo install --force rustfmt-nightly
  script:
    - cargo fmt -- --write-mode=diff
  allow_failure: true
  
test-coverage:
  stage: tests
  tags:
    - redshift-kcov-rs-stable
  script:
    - cargo test --no-run
    - kcov --verify target/cov_wotb target/debug/duniter_wotb-*
    - cat target/cov_wotb/duniter_wotb-*/coverage.json
    - kcov --verify target/cov_keys target/debug/duniter_keys-*
    - cat target/cov_wotb/duniter_keys-*/coverage.json
  tags:
    - kcov
  allow_failure: true
    
test-rust-stable:
  stage: tests
  tags:
    - redshift-rs-stable
  script:
    - cargo test
    
test-rust-beta:
  stage: tests
  tags:
    - redshift-rs-beta
  script:
    - rustup update
    - cargo test
  when: manual
  allow_failure: true
    
test-rust-nightly:
  stage: tests
  tags:
    - redshift-rs-nightly
  script:
    - rustup update
    - cargo test
  when: manual
  allow_failure: true
