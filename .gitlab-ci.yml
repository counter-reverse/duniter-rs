stages:
    - build_and_tests
    - clippy
    - fmt
    - publish
    
before_script:
    - export PATH="$HOME/.cargo/bin:$PATH"
    
build_and_tests:stable:
  stage: build_and_tests
  tags:
    - redshift-rs-stable
  script:
    - cargo test --all-features
    
build_and_tests:beta:
  stage: build_and_tests
  tags:
    - redshift-rs-beta
  script:
    - rustup update
    - cargo test --all-features
  when: manual
  allow_failure: true
    
build_and_tests:nightly:
  stage: build_and_tests
  image: rustlang/rust:nightly
  tags:
    - redshift-rs-nightly
  script:
    - cargo test --all-features
  when: manual
  allow_failure: true
  
clippy:
  stage: clippy
  image: rustlang/rust:nightly
  tags:
    - redshift-rs-nightly
  before_script:
    - export PATH="$HOME/.cargo/bin:$PATH"
    - cargo install --force clippy --verbose
  script:
    - cargo clippy --all -- -D warnings --verbose
  allow_failure: true  
  
fmt:
  stage: fmt
  image: rustlang/rust:nightly
  tags:
    - redshift-rs-nightly
  before_script:
    - export PATH="$HOME/.cargo/bin:$PATH"
    - cargo install --force rustfmt-nightly
  script:
    - cargo fmt -- --write-mode=diff
  allow_failure: true

publish:
  stage: publish
  tags:
    - redshift-rs-stable
  script:
    - ./gitlab/publish.sh
  only:
    - tags
  allow_failure: false
  when: manual